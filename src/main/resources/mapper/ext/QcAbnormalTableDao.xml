<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tools.st.mapper.QcAbnormalTableDao">
    <sql id = "select_field_list">
      qat.id as id,
      qat.com_id as comId,
      qat.qc_no as qcNo,
      qat.checked as checked,
      qat.qc_category_id as qcCategoryId,
      qat.qc_begin_time as qcBeginTime,
      qat.qc_end_time as qcEndTime,
      qat.qc_user_id as qcUserId,
      qat.materiel_id as materielId,
      qat.product_id as productId,
      qat.order_id as orderId,
      qat.qc_process_id as qcProcessId,
      qat.qc_result_id as qcResultId,
      qat.abnormal_grade_id as abnormalGradeId,
      qat.abnormal_type_id as abnormalTypeId,
      qat.abnormal_desc as abnormalDesc,
      qat.disposal_id as disposalId,
      qat.solution as solution,
      qat.responsible_user_id as responsibleUserId,
      qat.process_id as processId,
      qat.amt_of_abnormal as amtOfAbnormal,
      qat.amt_of_labor as amtOfLabor,
      qat.amt_of_loss as amtOfLoss,
      qat.amt_of_penalty as amtOfPenalty,
      qat.remarks as remarks,
      qat.review_user_id as reviewUserId,
      qat.review_time as reviewTime,
      qat.review_time as auditTime,
      qat.enableflg as enableflg,
      qat.created_by as createdBy,
      qat.created_time as createdTime,
      qat.updated_by as updatedBy,
      qat.updated_time as updatedTime,
      qat.audit_result as auditResult,
    </sql>

  <select id="findList" resultType="com.tools.st.entity.QcAbnormalTableVO">
    select
        <include refid="select_field_list" />
      (select count(1) from mold_file where parent_id=qat.id and file_type='qcAbnormalList' and enableflg=1) as fileCount,
      (select concat(cast(sum(ifnull(audit_result_code,0)) as char), '/', count(1))
        from qc_abnormal_audit
        where qc_id=qat.id
          and enableflg=1
          and cancelled=0) as auditCount
    from qc_abnormal_table qat

<!--      <if test="sqlParams.indexOf('qcUserIdU') >=0">-->
<!--             inner join sys_user qcUserIdU on qat.qc_user_id=qcUserIdU.user_id-->
<!--      </if>-->
<!--      <if test="sqlParams.indexOf('responsibleUserIdU') >=0">-->
<!--             inner join sys_user responsibleUserIdU on qat.responsible_user_id=responsibleUserIdU.user_id-->
<!--      </if>-->
<!--      <if test="sqlParams.indexOf('createdByU') >=0">-->
<!--             inner join sys_user createdByU on qat.created_by=createdByU.user_id-->
<!--      </if>-->
<!--      <if test="sqlParams.indexOf('reviewUserIdU') >=0">-->
<!--             inner join sys_user reviewUserIdU on qat.review_user_id=reviewUserIdU.user_id-->
<!--      </if>-->
<!--      <if test="sqlParams.indexOf('updatedByU') >=0">-->
<!--             inner join sys_user updatedByU on qat.updated_by=updatedByU.user_id-->
<!--      </if>-->

<!--      <if test="sqlParams.indexOf('materielIdM') >=0 || sqlParams.indexOf('moldBom') >=0">-->
<!--          inner join base_materiel materielIdM on qat.materiel_id=materielIdM.id-->
<!--      </if>-->
<!--      <if test="sqlParams.indexOf('moldBom') >= 0">-->
<!--          inner join mold_bom moldBom on moldBom.bom_materiel_id = materielIdM.id-->
<!--      </if>-->

<!--      <if test="sqlParams.indexOf('productIdM') >=0">-->
<!--          inner join base_materiel productIdM on qat.product_id=productIdM.id-->
<!--      </if>-->
<!--      <if test="sqlParams.indexOf('qcProcessIdP') >=0">-->
<!--          inner join mold_craft_process qcProcessIdP on qat.qc_process_id=qcProcessIdP.id-->
<!--      </if>-->
<!--      <if test="sqlParams.indexOf('processIdP') >=0">-->
<!--          inner join mold_craft_process processIdP on qat.process_id=processIdP.id-->
<!--      </if>-->
<!--      <if test="sqlParams.indexOf('madeNoO') >= 0">-->
<!--          inner join mold_order madeNoO on qat.order_id = madeNoO.id-->
<!--      </if>-->

    where qat.enableflg = 1
  </select>

  <select id="findKanban" resultType="com.tools.st.entity.QcAbnormalTableVO">
    select
      <include refid="select_field_list" />
      mo.made_type_id as madeTypeId
    from qc_abnormal_table qat left join mold_order mo on qat.order_id = mo.id
    where qat.enableflg = 1
    order by qat.qc_begin_time desc
  </select>

  <select id="findByQcNo" parameterType="java.lang.Long" resultMap="BaseResultMap">
    select
    <include refid="Base_Column_List" />
    from qc_abnormal_table
    where qc_no = #{qcNo,jdbcType=BIGINT} and enableflg = 1
  </select>

</mapper>